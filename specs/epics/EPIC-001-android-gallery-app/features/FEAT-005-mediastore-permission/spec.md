# Feature 规格说明：媒体库访问与权限管理

**Epic**：EPIC-001 - Android 相册应用
**Feature 类型**：Platform-Capability Feature
**Feature ID**：FEAT-005
**Feature Version**：v0.1.0
**EPIC 分支**：`epic/EPIC-001-android-gallery-app`
**Feature 目录**：`specs/epics/EPIC-001-android-gallery-app/features/FEAT-005-mediastore-permission/`
**创建时间**：2026-01-29
**状态**：草稿
**优先级**：P0
**输入**：用户描述：`"媒体库访问与权限管理：封装 MediaStore API 和权限申请逻辑"`

## 背景与价值 *（必填）*

- **背景**：Android 相册应用需要访问设备媒体库读取照片和视频，涉及复杂的权限申请逻辑和系统 API 调用。Android 10+ 引入 Scoped Storage，不同版本权限模型差异大，不同厂商 ROM 实现也存在兼容性问题。为避免各业务 Feature 重复实现，需要统一封装媒体库访问能力。
- **目标**：提供统一的媒体库访问接口，屏蔽 Android 版本差异和厂商兼容性问题，简化权限申请流程，为时间轴、图集、大图等业务 Feature 提供稳定可靠的数据源。
- **价值**：
  - **业务价值**：避免各 Feature 重复实现媒体访问逻辑，降低维护成本，统一权限体验
  - **技术价值**：统一处理兼容性问题，提供可复用的 Repository 层接口，支持后续功能扩展
  - **用户价值**：权限申请流程清晰友好，兼容性好，访问媒体库稳定可靠
- **范围（In Scope）**：
  - 封装 Android MediaStore API（读取照片/视频元数据、文件路径、缩略图）
  - 处理 Android 10-13+ 不同版本权限申请逻辑（READ_EXTERNAL_STORAGE / READ_MEDIA_IMAGES/VIDEO）
  - 权限拒绝时的用户引导流程（跳转设置页、友好提示）
  - 兼容不同厂商 ROM（小米、华为、OPPO、vivo、三星等）
  - 提供统一的 Repository 接口供其他 Feature 调用
  - 基础错误处理与降级方案
- **范围外（Out of Scope）**：
  - 照片编辑（暂时不做）
  - 照片删除、移动等写操作（仅提供读操作）
  - 云端同步与云相册（本 EPIC 不做）
  - 视频播放控制（由其他 Feature 负责）
  - 复杂的媒体库数据库优化（当前阶段无需）

## 依赖关系 *（必填）*

- **上游依赖**：
  - **Android 系统 API**：MediaStore API (Android 10+ / API Level 29+)
  - **Android 权限系统**：READ_EXTERNAL_STORAGE (Android 10-12) / READ_MEDIA_IMAGES, READ_MEDIA_VIDEO (Android 13+)
  - **系统设置页**：权限引导跳转需要系统设置应用可用
- **下游影响**：
  - **Feature 1（时间轴浏览）**：依赖本 Feature 提供照片列表数据
  - **Feature 3（图集管理与浏览）**：依赖本 Feature 提供图集列表和图集内容数据
  - **后续扩展功能**：任何需要访问媒体库的功能都将依赖本 Feature
- **外部依赖故障模式**：
  - **MediaStore API 不可用**：系统异常或版本不兼容 → 提示用户系统异常，无法读取照片
  - **权限被拒绝且无法引导**：用户拒绝权限且无法跳转设置 → 显示权限说明，提供手动设置指引
  - **厂商 ROM 兼容性问题**：特定机型 MediaStore 返回数据异常 → 日志记录，提供降级方案或错误提示
  - **读取超时**：大量媒体文件时 MediaStore 查询慢 → 设置超时时间，分批加载

> 说明（重要）：本 Feature 为 Capability Feature，不依赖其他 Feature，但为多个业务 Feature 提供基础能力。

## 验收与场景 *（必填）*

> 说明：本节用于"可测试"的需求验收；**不等同于技术 Story**（技术 Story 在 Plan 阶段拆分）。

### 核心用户旅程（可选但强烈建议）

#### 旅程 1 - 首次使用授权

- **描述**：用户首次打开应用，需要授权访问照片和视频
- **成功信号**：用户授权成功，应用可以读取媒体库数据
- **验收场景**：
  1. **前提** 用户首次打开应用，未授予任何权限，**当** 应用请求媒体访问权限，**则** 系统弹出权限请求弹窗，用户可选择允许/拒绝
  2. **前提** 用户授予权限，**当** 应用调用媒体库访问接口，**则** 成功返回照片和视频列表数据

#### 旅程 2 - 权限被拒绝后的引导

- **描述**：用户拒绝权限后，应用引导用户前往设置授权
- **成功信号**：用户理解为何需要权限，可轻松跳转设置页授权
- **验收场景**：
  1. **前提** 用户拒绝了权限，**当** 应用尝试访问媒体库，**则** 显示友好提示说明需要权限的原因，提供"前往设置"按钮
  2. **前提** 用户点击"前往设置"，**当** 跳转到系统设置页，**则** 用户可在设置页授予权限，返回应用后自动重试

### 边界与异常场景（必填）

- **无照片/视频场景** → 返回空列表，不报错，提示用户"暂无照片"
- **大量照片场景（10,000+ 张）** → 支持分页加载（首屏 50 张，后续每页 30 张），首屏数据就绪时间 < 2 秒，不阻塞 UI
- **权限被永久拒绝（用户勾选"不再询问"）** → 检测到无法再次弹窗时，直接引导跳转设置页
- **特定厂商 ROM 兼容性问题** → 日志记录机型信息和错误详情，提供降级提示或兼容性修复建议
- **读取超时或崩溃** → 设置超时时间（5秒），超时返回错误，记录日志供分析
- **并发访问媒体库** → 确保接口线程安全，避免并发调用时数据混乱或崩溃
- **应用在后台被杀死后恢复** → 权限状态正确保存，恢复后无需重新申请
- **系统升级（Android 版本变化）** → 自动适配新权限模型，无需用户手动操作

## FR / NFR *（必填）*

### FR（Functional Requirements）

> 规则：每条 FR 必须**可测试**，避免"提升体验/更快/更稳定"这类不可验证表述。

- **FR-001**：系统必须能够读取设备中所有照片的元数据（包括文件路径、创建时间、修改时间、文件大小、MIME类型），支持 JPEG、PNG、HEIC、WebP 等常见格式
- **FR-002**：系统必须能够读取设备中所有视频的元数据（包括文件路径、创建时间、修改时间、文件大小、时长、MIME类型），支持 MP4、MOV、AVI、MKV 等常见格式
- **FR-003**：系统必须能够获取照片和视频的缩略图（Thumbnail），支持三种尺寸：小（256px）、中（512px）、大（1024px）
- **FR-004**：系统必须根据 Android 版本自动选择正确的权限申请方式：Android 10-12 使用 READ_EXTERNAL_STORAGE，Android 13+ 使用 READ_MEDIA_IMAGES 和 READ_MEDIA_VIDEO
- **FR-005**：系统必须在用户拒绝权限时，显示友好的权限说明（说明为何需要权限），并提供"前往设置"按钮跳转到系统设置页
- **FR-006**：系统必须检测权限是否被永久拒绝（用户勾选"不再询问"），使用 `shouldShowRequestPermissionRationale()` 返回 false 且权限未授予作为判定条件，并在此情况下直接引导跳转设置页而非再次弹窗
- **FR-007**：系统必须提供统一的 Repository 接口（如 `MediaRepository.getPhotos()`, `MediaRepository.getVideos()`），供其他 Feature 调用，接口设计清晰、易用
- **FR-008**：系统必须支持分页加载媒体数据，避免一次性加载大量数据导致性能问题，支持指定页码和每页数量。默认策略：首屏加载 50 张，后续分页每页 30 张
- **FR-009**：系统必须在读取媒体库失败时返回明确的分层错误类型（PermissionError、SystemError、DataError），每种错误类型包含具体错误码（如 PERMISSION_DENIED、API_UNAVAILABLE、TIMEOUT、EMPTY_DATA等），供调用方针对性处理
- **FR-010**：系统必须兼容主流厂商 ROM（小米、华为、OPPO、vivo、三星），在已知兼容性问题上提供降级方案或修复逻辑

### NFR（Non-Functional Requirements）

> 规则：每条 NFR 必须**量化**并附带验收方式；细化评估在 Plan 阶段完成。

#### 性能（Performance）

- **NFR-PERF-001**：首屏数据加载（获取前 50 张照片元数据）就绪时间 < 2 秒（P90），在 10,000 张照片场景下测试
- **NFR-PERF-002**：分页加载每页数据（30 张）响应时间 < 500ms（P90）
- **NFR-PERF-003**：缩略图获取时间 < 300ms（P90），单张缩略图

#### 内存（Memory）

- **NFR-MEM-001**：媒体库查询过程中内存增量 < 50MB（峰值），查询完成后及时释放
- **NFR-MEM-002**：缓存的元数据占用内存 < 20MB（常驻），使用 LRU（最近最少使用）淘汰策略，当缓存达到 16MB 时开始自动淘汰

#### 安全与隐私（Security/Privacy）

- **NFR-SEC-001**：权限申请符合 Android 最小化原则，仅申请必要权限（READ_MEDIA_IMAGES/VIDEO），不申请其他无关权限（如位置、联系人等）
- **NFR-SEC-002**：用户媒体数据不上传至服务器，不与第三方共享，符合隐私政策（关联 EPIC-NFR-SEC-002）
- **NFR-SEC-003**：权限被拒绝时，不强制用户授权，允许用户在无权限状态下退出或了解权限用途

#### 兼容性（Compatibility）

- **NFR-COMPAT-001**：支持 Android 10+ (API Level 29+) 所有版本，包括 Android 10, 11, 12, 13, 14
- **NFR-COMPAT-002**：在主流厂商 ROM 上通过兼容性测试（小米 MIUI、华为 HarmonyOS/EMUI、OPPO ColorOS、vivo OriginOS、三星 One UI），无功能阻塞
- **NFR-COMPAT-003**：在低端设备（2GB RAM）上可正常运行，无崩溃或 ANR

#### 可观测性（Observability）

- **NFR-OBS-001**：关键操作需埋点（权限申请成功/失败、媒体库查询成功/失败、读取耗时），采样率 10%
- **NFR-OBS-002**：兼容性问题需记录日志（机型、ROM版本、错误详情），供问题排查
- **NFR-OBS-003**：权限被拒绝场景需埋点统计（拒绝次数、永久拒绝次数），供产品分析

#### 可靠性（Reliability）

- **NFR-REL-001**：MediaStore API 不可用时，提示用户系统异常，不崩溃
- **NFR-REL-002**：读取超时时（> 5 秒），返回错误而非一直阻塞，记录日志
- **NFR-REL-003**：接口调用成功率 > 99%（排除权限拒绝和系统异常），在正常权限授予情况下

## 验收标准（Feature Level）*（必填）*

- **AC-001**：在 Android 10、11、12、13、14 设备上，应用能够成功申请权限并读取照片列表（关联: FR-001, FR-004, NFR-COMPAT-001）
- **AC-002**：在 10,000 张照片的设备上，首屏数据加载时间 < 2 秒（关联: FR-008, NFR-PERF-001）
- **AC-003**：用户拒绝权限后，显示友好提示并提供"前往设置"按钮，点击可跳转到系统设置页（关联: FR-005, FR-006）
- **AC-004**：在小米、华为、OPPO、vivo、三星主流机型上，媒体库读取功能正常，无兼容性阻塞（关联: FR-010, NFR-COMPAT-002）
- **AC-005**：分页加载每页 30 张照片，响应时间 < 500ms（关联: FR-008, NFR-PERF-002）
- **AC-006**：缩略图获取时间 < 300ms，支持小（256px）、中（512px）、大（1024px）三种尺寸，显示正常不模糊（关联: FR-003, NFR-PERF-003）
- **AC-007**：内存占用符合预算，查询过程中增量 < 50MB，查询完成后回收（关联: NFR-MEM-001）
- **AC-008**：权限申请埋点正常上报，可在后台看到权限申请成功/失败数据（关联: NFR-OBS-001）
- **AC-009**：MediaStore API 不可用时，应用不崩溃，提示用户系统异常（关联: NFR-REL-001）
- **AC-010**：用户授权后，其他 Feature 可通过 Repository 接口成功获取照片/视频列表（关联: FR-007）

## 核心实体（如涉及数据则必填）

- **MediaItem（媒体项）**：代表一张照片或一个视频，包含属性：
  - `id`: Long - MediaStore 中的唯一 ID
  - `uri`: Uri - 媒体文件的 URI（用于访问）
  - `displayName`: String - 显示名称（文件名）
  - `mimeType`: String - MIME 类型（如 image/jpeg, video/mp4）
  - `dateAdded`: Long - 添加时间（时间戳）
  - `dateModified`: Long - 修改时间（时间戳）
  - `size`: Long - 文件大小（字节）
  - `width`: Int - 宽度（像素）
  - `height`: Int - 高度（像素）
  - `duration`: Long? - 视频时长（毫秒，仅视频）
  - `bucketId`: Long? - 所属图集 ID（用于图集分组）
  - `bucketDisplayName`: String? - 所属图集名称

- **Album（图集/相册）**：代表一个系统相册（如"相机"、"截图"），包含属性：
  - `id`: Long - 图集唯一 ID（bucketId）
  - `name`: String - 图集名称（如"相机"、"截图"、"下载"）
  - `coverUri`: Uri - 封面图片 URI（图集中最新一张照片）
  - `mediaCount`: Int - 图集内媒体数量

- **PermissionState（权限状态）**：代表当前权限状态，枚举值：
  - `GRANTED` - 已授权
  - `DENIED` - 拒绝（可再次询问）
  - `PERMANENTLY_DENIED` - 永久拒绝（不再询问）
  - `NOT_REQUESTED` - 未请求

- **MediaError（媒体访问错误）**：分层错误类型，包含三个子类型：
  - **PermissionError（权限错误）**：
    - `PERMISSION_DENIED` - 权限被拒绝（可再次申请）
    - `PERMISSION_PERMANENTLY_DENIED` - 权限被永久拒绝（需引导跳转设置）
  - **SystemError（系统错误）**：
    - `API_UNAVAILABLE` - MediaStore API 不可用
    - `TIMEOUT` - 读取超时（超过5秒）
    - `UNKNOWN_SYSTEM_ERROR` - 未知系统错误
  - **DataError（数据错误）**：
    - `EMPTY_DATA` - 媒体库为空（无照片/视频）
    - `INVALID_FORMAT` - 数据格式异常
    - `CORRUPTED_FILE` - 文件损坏无法读取

## 假设与约束 *（必填）*

- **假设**：
  - **假设 1**：用户设备运行 Android 10+ (API Level 29+)，若低于此版本则不支持（影响：应用在低版本无法运行，需在安装时限制）
  - **假设 2**：用户设备有存储空间且媒体库可访问，若设备存储损坏则无法读取（影响：提示用户设备异常）
  - **假设 3**：MediaStore API 返回的数据格式符合官方文档定义，若厂商定制导致数据异常则需兼容处理（影响：可能需要针对特定厂商做适配）
  - **假设 4**：用户媒体文件数量在 50,000 张以内，若超过则可能需要额外性能优化（影响：分页加载和缓存策略可能需要调整）
- **约束**：
  - **平台约束**：必须使用 Android MediaStore API，不得直接扫描文件系统（违反 Scoped Storage 规范）
  - **权限约束**：仅申请读权限，不申请写权限（删除、移动等操作本 EPIC 不支持）
  - **性能约束**：首屏数据加载 < 2 秒，分页加载 < 500ms，缩略图 < 300ms（关联 EPIC-NFR-PERF）
  - **内存约束**：查询增量 < 50MB，元数据缓存 < 20MB（关联 NFR-MEM）
  - **兼容性约束**：必须兼容 Android 10-14，必须在主流厂商 ROM 上测试通过

## 澄清内容

### 会话 2026-01-29

- 问题：权限状态转换检测机制 - 如何检测 PERMANENTLY_DENIED 状态（用户勾选"不再询问"）？ → 答案：使用 `shouldShowRequestPermissionRationale()` 返回 false 且权限未授予时判定为永久拒绝
- 问题：分页加载默认策略 - 默认每页数量和首屏加载数量的推荐值？ → 答案：默认每页 30 张，首屏加载 50 张
- 问题：缩略图尺寸策略 - 小/中/大三种尺寸的具体像素值？ → 答案：小 256px，中 512px，大 1024px
- 问题：错误类型定义 - 如何设计错误类型的枚举和层级结构？ → 答案：分层枚举：PermissionError（拒绝/永久拒绝）、SystemError（API不可用/超时）、DataError（数据为空/格式错误）
- 问题：元数据缓存策略 - 具体的缓存淘汰算法和触发时机？ → 答案：LRU（最近最少使用）策略，当缓存达到 16MB 时开始淘汰

## 变更记录

| 版本 | 日期 | 变更摘要 | 影响分析 | 是否需要回滚设计 |
|---|---|---|---|---|
| v0.1.0 | 2026-01-29 | 初始版本 | 无 | 否 |
