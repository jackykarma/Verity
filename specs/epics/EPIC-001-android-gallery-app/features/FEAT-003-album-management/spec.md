# Feature 规格说明：图集管理与浏览

**Epic**：EPIC-001 - Android 相册应用
**Feature 类型**：Product Feature
**Feature ID**：FEAT-003
**Feature Version**：v0.1.0
**EPIC 分支**：`epic/EPIC-001-android-gallery-app`
**Feature 目录**：`specs/epics/EPIC-001-android-gallery-app/features/FEAT-003-album-management/`
**创建时间**：2026-01-29
**状态**：草稿
**输入**：用户描述：`"图集管理与浏览：展示系统相册图集列表，支持进入图集查看内容，从图集内照片进入大图浏览"`

## 背景与价值 *（必填）*

- **背景**：用户的照片不仅可以按时间维度浏览，还需要按相册图集（如"相机"、"截图"、"下载"等）进行组织浏览。不同来源的照片自然分类在不同图集中，用户需要快速找到特定类型的照片。
- **目标**：提供系统相册图集的浏览入口，用户可以查看所有图集列表，进入图集查看该图集内的所有照片/视频，并支持从图集内进入大图浏览模式，实现与时间轴一致的流畅体验。
- **价值**：
  - **用户价值**：按相册维度快速定位照片（如查看所有截图、查看相机拍摄的照片），提供多维度的照片组织方式，提升查找效率
  - **业务价值**：完善相册应用的核心浏览功能，与时间轴形成互补，提升产品完整度
  - **技术价值**：复用媒体库访问能力和图片加载框架，验证架构的可复用性
- **范围（In Scope）**：
  - 展示系统相册图集列表（读取 Android MediaStore 中的相册分类）
  - 显示图集封面缩略图和照片/视频数量
  - 进入图集查看该图集的所有照片/视频（列表展示）
  - 从图集内照片进入大图浏览（复用 Feature 2 的大图浏览能力）
  - 图集内列表体验与时间轴一致（滚动流畅、缩略图加载快速）
- **范围外（Out of Scope）**：
  - 创建、删除、重命名图集（仅读取系统图集，不提供编辑功能）
  - 图集排序、图集合并功能
  - 隐藏图集功能
  - 图集封面自定义（使用系统默认封面）
  - 图集内照片排序（默认按时间倒序）

## 依赖关系 *（必填）*

- **上游依赖**：
  - **Feature 5 (媒体库访问与权限管理)**：依赖 MediaStore API 封装，读取系统相册图集信息（图集名称、路径、封面、数量）
  - **Feature 6 (图片加载与缓存框架)**：依赖图片加载框架展示图集封面和图集内照片缩略图
  - **Feature 1 (时间轴浏览)**：依赖 UI 基础框架、导航架构、错误处理机制
  - **Feature 2 (大图浏览与交互)**：依赖大图浏览模块，从图集内照片跳转到大图浏览
- **下游影响**：
  - 为后续可能的图集编辑功能（创建、删除、重命名）提供浏览基础
  - 为 AI 功能（如 AI 创作、故事回忆）提供按图集维度选择照片的能力
- **外部依赖故障模式**：
  - **MediaStore API 不可用或读取失败**：无法获取图集列表，需提示用户"无法加载图集，请检查权限或重启应用"
  - **图集封面缩略图加载失败**：显示占位符图标，不影响图集列表展示
  - **大图浏览模块不可用**：从图集内照片进入大图浏览失败，需提示用户"无法打开大图"

> 说明（重要）：本 Feature 是业务 Feature，核心依赖 Capability Feature (Feature 5, 6) 提供的能力，不重复实现媒体库访问和图片加载逻辑。

## 验收与场景 *（必填）*

> 说明：本节用于"可测试"的需求验收；**不等同于技术 Story**（技术 Story 在 Plan 阶段拆分）。

### 核心用户旅程（可选但强烈建议）

#### 旅程 1 - 浏览图集列表并进入图集

- **描述**：用户从主界面进入图集页，查看分组展示的图集列表（置顶分组、更多图集分组、媒体类型分组），选择一个图集进入查看该图集内的所有照片（瀑布流布局）
- **成功信号**：用户可以看到分组展示的图集列表，置顶图集排在前面（最近项目、相机、视频等），点击图集后进入图集内瀑布流照片列表页，照片列表流畅加载且视觉美观
- **验收场景**：
  1. **前提** 用户已授权存储权限，设备中有多个系统相册图集，**当** 用户进入图集页，**则** 看到分组展示的图集列表：置顶分组显示"最近项目"、"相机"、"视频"、"个人收藏"、"实况照片"（按顺序），更多图集分组显示其他系统图集，每个图集显示封面缩略图和照片数量（如"相机 123 张"）
  2. **前提** 图集列表已展示，**当** 用户点击某个图集（如"相机"），**则** 进入图集内照片列表页，采用瀑布流布局（多列，根据照片宽高比动态调整高度），显示该图集的所有照片/视频，按时间倒序排列
  3. **前提** 图集内照片列表已展示（瀑布流布局），**当** 用户滚动列表，**则** 照片缩略图流畅加载，滚动帧率 ≥ 55fps，无卡顿，瀑布流布局计算无明显延迟

#### 旅程 2 - 从图集内照片进入大图浏览

- **描述**：用户在图集内照片列表中点击某张照片，进入大图浏览模式，可以缩放、滑动切换该图集内的其他照片，滑到图集边界停止
- **成功信号**：用户可以从图集内照片顺畅进入大图浏览，切换范围限定在当前图集内，滑到边界时停止
- **验收场景**：
  1. **前提** 用户在图集内照片列表中，**当** 点击某张照片，**则** 进入大图浏览模式，显示该照片的大图，大图首帧显示时间 < 500ms
  2. **前提** 大图浏览模式已打开，**当** 用户左右滑动，**则** 切换到该图集内的其他照片，切换响应时间 < 200ms，滑到图集第一张或最后一张时停止，不跨图集切换
  3. **前提** 大图浏览模式已打开，**当** 用户双指缩放，**则** 缩放操作流畅，帧率 ≥ 60fps

### 边界与异常场景（必填）

- **图集为空**（用户设备中某个图集没有照片） → 图集列表仍显示该图集，但照片数量显示"0 张"，点击进入后显示"该图集暂无照片"提示
- **图集封面缩略图加载失败** → 显示占位符图标（如默认相册图标），不影响图集列表展示
- **MediaStore API 读取图集列表失败** → 显示"无法加载图集，请检查权限或重启应用"提示，提供重试按钮
- **图集列表数据加载超时**（> 5 秒） → 显示加载超时提示，提供重试按钮
- **从图集内进入大图浏览失败** → 显示"无法打开大图"提示，返回图集内列表
- **图集内列表滚动时内存不足** → 启用图片缓存淘汰策略，保证应用不崩溃，列表可继续滚动
- **大图浏览滑到图集边界**（第一张或最后一张） → 停止切换，显示边界反馈效果（如弹性回弹动画），不跨图集切换
- **图集内照片宽高比数据缺失** → 使用默认宽高比（如 1:1）进行瀑布流布局，不影响列表展示

## FR / NFR *（必填）*

### FR（Functional Requirements）

> 规则：每条 FR 必须**可测试**，避免"提升体验/更快/更稳定"这类不可验证表述。

- **FR-001**：系统必须展示设备中所有系统相册图集列表，采用分组展示：
  - **置顶分组**：按顺序显示"最近项目"（所有照片）、"相机"、"视频"、"个人收藏"、"实况照片"（若设备支持）
  - **更多图集分组**：显示其他系统图集（如"截图"、"下载"、"微信"等）
  - **媒体类型分组**：显示特定类型图集（如"实况照片"、"GIF"等）
  - 每个图集显示封面缩略图（使用图集内最新时间的照片作为封面）和照片/视频数量
  - 关联：EPIC-FR-003
- **FR-002**：用户必须能够点击图集进入图集内照片列表页，显示该图集的所有照片/视频，采用瀑布流布局（根据照片原始宽高比展示不同高度），按时间倒序排列
  - 关联：EPIC-FR-003
- **FR-003**：用户必须能够从图集内照片列表中点击照片，进入大图浏览模式（复用 Feature 2 的大图浏览能力），大图浏览时左右滑动切换仅限当前图集内的照片，滑到图集边界停止
  - 关联：EPIC-FR-003, EPIC-FR-002
- **FR-004**：图集内照片列表必须支持滚动加载（分页），避免一次性加载大量照片导致性能问题
- **FR-005**：图集封面缩略图加载失败时，必须显示占位符图标，不影响图集列表展示
- **FR-006**：图集列表数据加载失败时，必须显示错误提示和重试按钮
- **FR-007**："最近项目"图集必须显示所有照片/视频（等同于时间轴浏览的全部内容）
- **FR-008**：大图浏览滑到图集边界（第一张或最后一张）时，必须停止切换并显示边界反馈效果（如弹性回弹动画）
- **FR-009**：图集内照片列表必须使用瀑布流布局（多列，根据照片原始宽高比动态调整高度），保持视觉美观性

### NFR（Non-Functional Requirements）

> 规则：每条 NFR 必须**量化**并附带验收方式；细化评估在 Plan 阶段完成。

#### 性能（Performance）

- **NFR-PERF-001**：图集列表数据加载就绪时间 < 2 秒（P90），即用户进入图集页后，图集列表数据可开始渲染的时间
  - 关联：EPIC-NFR-PERF-002
  - 验收方式：性能测试，采集 P90 指标，确保 90% 的加载时间 < 2 秒
- **NFR-PERF-002**：图集封面缩略图首帧显示延迟 < 300ms（进入可视区域后，P90）
  - 关联：EPIC-NFR-PERF-003
  - 验收方式：性能测试，测量图集封面缩略图进入可视区域后到首帧显示的时间
- **NFR-PERF-003**：图集内照片列表（瀑布流布局）滚动帧率 ≥ 55fps（P90），无明显卡顿，瀑布流布局计算不影响滚动性能
  - 关联：EPIC-NFR-PERF-007
  - 验收方式：使用 Systrace 或 Android Profiler 采集滚动帧率，确保 P90 帧率 ≥ 55fps，主线程布局计算时间 < 16ms
- **NFR-PERF-004**：图集内照片缩略图首帧显示延迟 < 300ms（进入可视区域后，P90）
  - 关联：EPIC-NFR-PERF-003
  - 验收方式：性能测试，测量图集内照片缩略图进入可视区域后到首帧显示的时间
- **NFR-PERF-005**：从图集内照片进入大图浏览的响应时间 < 500ms（点击到大图首帧显示，P90）
  - 关联：EPIC-NFR-PERF-004
  - 验收方式：性能测试，测量点击照片到大图首帧显示的时间

#### 内存（Memory）

- **NFR-MEM-001**：图集列表页运行时内存增量 < 50MB（相比主界面）
  - 关联：EPIC-NFR-MEM-001
  - 验收方式：使用 Android Profiler 采集内存占用，对比主界面与图集列表页的内存差异
- **NFR-MEM-002**：图集内照片列表页运行时内存增量 < 100MB（相比主界面），支持至少 1,000 张照片的图集
  - 关联：EPIC-NFR-MEM-001
  - 验收方式：在包含 1,000 张照片的图集中滚动浏览，使用 Android Profiler 采集内存占用

#### 安全与隐私（Security/Privacy）

- **NFR-SEC-001**：图集列表和图集内照片列表必须符合权限管理规范，仅在用户授权后访问媒体库
  - 关联：EPIC-NFR-SEC-001
  - 验收方式：手工测试，未授权时无法进入图集页，提示用户授权
- **NFR-SEC-002**：图集访问记录不上传至服务器，符合隐私政策
  - 关联：EPIC-NFR-SEC-002
  - 验收方式：代码审查 + 抓包测试，确保无数据上传

#### 可观测性（Observability）

- **NFR-OBS-001**：图集列表加载、图集内列表加载、进入大图浏览等关键操作需埋点采集性能数据，采样率 10%
  - 关联：EPIC-NFR-OBS-001
  - 验收方式：埋点数据验证，确保关键操作有埋点记录

#### 可靠性（Reliability）

- **NFR-REL-001**：图集列表加载失败时，必须提供重试机制，不导致应用崩溃
  - 关联：EPIC-NFR-COMPAT-001
  - 验收方式：模拟 MediaStore API 失败场景，验证错误提示和重试功能
- **NFR-REL-002**：图集内列表加载失败时，必须提供降级方案（如显示缓存数据或空状态），不导致应用崩溃
  - 验收方式：模拟网络异常或 API 失败场景，验证降级逻辑

#### 兼容性（Compatibility）

- **NFR-COMPAT-001**：支持 Android 10+ (API Level 29+)，兼容主流厂商 ROM（小米、华为、OPPO、vivo、三星）
  - 关联：EPIC-NFR-COMPAT-001
  - 验收方式：在目标机型上进行兼容性测试，确保图集列表和图集内列表功能正常

## 验收标准（Feature Level）*（必填）*

- **AC-001**：用户进入图集页，可在 2 秒内（P90）看到分组展示的图集列表，置顶分组按顺序显示"最近项目"、"相机"、"视频"、"个人收藏"、"实况照片"，每个图集显示封面和照片数量（关联：FR-001, NFR-PERF-001）
- **AC-002**：图集封面缩略图首帧显示延迟 < 300ms（P90）（关联：FR-001, NFR-PERF-002）
- **AC-003**：用户点击图集，进入图集内照片列表页，采用瀑布流布局，照片按时间倒序排列（关联：FR-002, FR-009）
- **AC-004**：图集内照片列表（瀑布流布局）滚动帧率 ≥ 55fps（P90），无明显卡顿，布局计算不影响滚动性能（关联：FR-004, FR-009, NFR-PERF-003）
- **AC-005**：图集内照片缩略图首帧显示延迟 < 300ms（P90）（关联：FR-004, NFR-PERF-004）
- **AC-006**：用户点击图集内照片，进入大图浏览模式，大图首帧显示时间 < 500ms（P90）（关联：FR-003, NFR-PERF-005）
- **AC-007**：图集内照片列表支持至少 1,000 张照片，内存增量 < 100MB（关联：NFR-MEM-002）
- **AC-008**：图集列表加载失败时，显示错误提示和重试按钮，点击重试可重新加载（关联：FR-006, NFR-REL-001）
- **AC-009**：图集封面缩略图加载失败时，显示占位符图标（关联：FR-005）
- **AC-010**：图集访问记录不上传至服务器（关联：NFR-SEC-002）
- **AC-011**：在 Android 10-14 和主流厂商 ROM 上测试通过，无兼容性问题（关联：NFR-COMPAT-001）
- **AC-012**："最近项目"图集必须显示所有照片/视频，内容与时间轴一致（关联：FR-007）
- **AC-013**：大图浏览滑到图集边界时停止切换，显示边界反馈效果，不跨图集切换（关联：FR-003, FR-008）
- **AC-014**：图集内瀑布流布局根据照片原始宽高比动态调整高度，视觉美观无明显空白或错位（关联：FR-009）

## 核心实体（如涉及数据则必填）

- **Album（图集）**：
  - 含义：系统相册图集（如"相机"、"截图"、"下载"等）
  - 核心属性：图集 ID、图集名称、图集路径、封面缩略图 URI、照片/视频数量、图集类型（系统图集/媒体类型图集）
  - 关系：一个图集包含多张照片/视频（Media 实体）
- **AlbumGroup（图集分组）**：
  - 含义：图集列表的分组（置顶分组、更多图集分组、媒体类型分组）
  - 核心属性：分组名称、分组类型、包含的图集列表
  - 关系：一个分组包含多个图集（Album 实体）
- **Media（媒体）**：
  - 含义：照片或视频
  - 核心属性：媒体 ID、文件路径、缩略图 URI、拍摄时间、媒体类型（照片/视频）、宽度、高度、宽高比（用于瀑布流布局计算）
  - 关系：属于一个或多个图集（Album 实体）

## 假设与约束 *（必填）*

- **假设**：
  - **假设 1**：用户设备中至少有一个系统相册图集（如"相机"），若无图集则显示"暂无图集"提示（影响：无图集则功能不可用）
  - **假设 2**：图集内照片数量在 10,000 张以内（影响：超过则可能需要额外性能优化）
  - **假设 3**：Feature 5 (媒体库访问与权限管理) 和 Feature 6 (图片加载与缓存框架) 已完成并可用（影响：若未完成则本 Feature 无法开发）
  - **假设 4**：Feature 2 (大图浏览与交互) 已完成并可用（影响：若未完成则无法从图集内进入大图浏览）
- **约束**：
  - **平台**：Android 10+ (API Level 29+)，需适配 Scoped Storage
  - **权限**：需要 READ_MEDIA_IMAGES、READ_MEDIA_VIDEO 权限（Android 13+）或 READ_EXTERNAL_STORAGE（Android 10-12）
  - **依赖约束**：必须复用 Feature 1 的 UI 基础框架、Feature 5 的媒体库访问能力、Feature 6 的图片加载框架、Feature 2 的大图浏览模块，不得重复实现
  - **性能预算**：图集列表数据加载 < 2 秒，图集内列表体验与时间轴一致（滚动帧率 ≥ 55fps，缩略图首帧 < 300ms）

## 需求追溯（预留，Plan 后填写）

> 说明：此表在 Plan 的 Story Breakdown 完成后填写，用于确保 FR/NFR 被 Story 覆盖；Implement 不得擅自改写 FR/NFR。

| FR/NFR ID | 计划覆盖的 Story ID（Plan） | 任务覆盖（Tasks） | 备注 |
|---|---|---|---|
| FR-001 | ST-??? | T??? |  |
| FR-002 | ST-??? | T??? |  |
| FR-003 | ST-??? | T??? |  |
| FR-004 | ST-??? | T??? |  |
| FR-005 | ST-??? | T??? |  |
| FR-006 | ST-??? | T??? |  |
| FR-007 | ST-??? | T??? |  |
| FR-008 | ST-??? | T??? |  |
| FR-009 | ST-??? | T??? |  |
| NFR-PERF-001 | ST-??? | T??? |  |
| NFR-PERF-002 | ST-??? | T??? |  |
| NFR-PERF-003 | ST-??? | T??? |  |
| NFR-PERF-004 | ST-??? | T??? |  |
| NFR-PERF-005 | ST-??? | T??? |  |
| NFR-MEM-001 | ST-??? | T??? |  |
| NFR-MEM-002 | ST-??? | T??? |  |
| NFR-SEC-001 | ST-??? | T??? |  |
| NFR-SEC-002 | ST-??? | T??? |  |
| NFR-OBS-001 | ST-??? | T??? |  |
| NFR-REL-001 | ST-??? | T??? |  |
| NFR-REL-002 | ST-??? | T??? |  |
| NFR-COMPAT-001 | ST-??? | T??? |  |

## 澄清内容

### 会话 2026-01-29

- 问题：图集列表排序规则 → 答案：分组展示：置顶分组（最近项目/所有照片、相机、视频、个人收藏、实况照片）、更多图集分组（其他系统图集）、媒体类型分组（实况照片、GIF等）
- 问题：图集封面选择逻辑 → 答案：图集内最新（时间最晚）的一张照片
- 问题：图集内照片切换范围 → 答案：仅限当前图集内切换（滑到图集边界停止）
- 问题：图集内照片显示布局 → 答案：瀑布流布局（不同高度，类似 Pinterest）

## 变更记录（增量变更）

| 版本 | 日期 | 变更范围 | 变更摘要 | 影响 | 是否需要回滚 |
|---|---|---|---|---|---|
| v0.1.0 | 2026-01-29 | 初始版本 | 创建 Feature 3 规格说明 | 无 | 否 |
