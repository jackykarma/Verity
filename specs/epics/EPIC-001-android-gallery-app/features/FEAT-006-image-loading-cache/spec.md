# Feature 规格说明：图片加载与缓存框架

**Epic**：EPIC-001 - Android 相册应用
**Feature 类型**：Platform-Capability Feature
**Feature ID**：FEAT-006
**Feature Version**：v0.1.0
**EPIC 分支**：`epic/EPIC-001-android-gallery-app`
**Feature 目录**：`specs/epics/EPIC-001-android-gallery-app/features/FEAT-006-image-loading-cache/`
**创建时间**：2026-01-29
**状态**：草稿
**优先级**：P0
**输入**：用户描述：`"图片加载与缓存框架：集成 Glide/Coil，配置缓存策略和性能优化"`

## 背景与价值 *（必填）*

- **背景**：相册应用的核心体验在于图片的快速加载和流畅显示。用户在浏览时间轴、图集、大图时，需要频繁加载大量图片（缩略图和原图）。没有高效的图片加载与缓存机制，会导致加载慢、卡顿、内存溢出等问题，严重影响用户体验。**数据加载速度与图片加载显示速度为本 EPIC 的核心关注点。**
- **目标**：构建统一的图片加载与缓存框架，确保列表缩略图首帧显示 < 300ms、大图首帧显示 < 500ms，支持内存与磁盘缓存，优化缓存命中率，为所有浏览 Feature 提供高性能的图片加载能力。
- **价值**：
  - **用户价值**：图片快速呈现，浏览流畅无卡顿，加载失败时有友好占位符
  - **业务价值**：提升核心体验指标（图片显示速度），为用户留存和满意度奠定基础
  - **技术价值**：统一图片加载逻辑，避免各 Feature 重复实现，优化内存和性能，支持性能监控
- **范围（In Scope）**：
  - 选择并集成图片加载库（Glide 或 Coil）
  - 配置内存缓存策略（LRU，最大 150MB）
  - 配置磁盘缓存策略（LRU，最大 500MB）
  - 支持缩略图加载（统一 256x256px，用于时间轴、图集、缩图轴等所有列表场景）和原图加载（初始缩放到屏幕尺寸，用户缩放时加载高清细节）
  - 处理加载失败场景（显示破损图标占位符，记录错误日志）
  - 显示加载中状态（灰色方块占位符）
  - 性能监控（加载时间埋点、缓存命中率统计）
  - 内存与缓存自动淘汰机制
  - 支持预加载（时间轴列表预加载下3屏缩略图，大图浏览预加载前后各3张原图）
- **范围外（Out of Scope）**：
  - 视频播放（由其他 Feature 负责）
  - GIF 动画高级处理（当前阶段无需）
  - 图片编辑（暂时不做）
  - 网络图片加载（本 EPIC 仅本地相册）
  - 图片压缩/格式转换（当前阶段无需）

## 依赖关系 *（必填）*

- **上游依赖**：
  - **图片加载库**：Glide (com.github.bumptech.glide:glide) 或 Coil (io.coil-kt:coil)，需选型确定
  - **Android 系统**：BitmapFactory、ImageDecoder (Android 10+) 用于图片解码
  - **Feature 1（媒体库访问）**：依赖其提供的媒体 URI，用于加载本地图片
- **下游影响**：
  - **Feature 1（时间轴浏览）**：依赖本 Feature 加载列表缩略图
  - **Feature 2（大图浏览与交互）**：依赖本 Feature 加载原图和缩图轴缩略图
  - **Feature 3（图集管理与浏览）**：依赖本 Feature 加载图集封面和列表缩略图
  - **后续扩展功能**：任何需要显示图片的功能都将依赖本 Feature
- **外部依赖故障模式**：
  - **图片加载库不可用**：应用无法加载图片 → 提示用户应用异常，记录日志
  - **图片文件损坏**：解码失败 → 显示错误占位符，记录日志
  - **磁盘缓存空间不足**：无法写入缓存 → 降级为仅内存缓存，清理旧缓存
  - **内存不足**：缓存淘汰频繁 → 降低缓存大小，触发 GC，记录低内存事件

> 说明（重要）：本 Feature 为 Capability Feature，为所有需要显示图片的业务 Feature 提供基础能力。

## 验收与场景 *（必填）*

> 说明：本节用于"可测试"的需求验收；**不等同于技术 Story**（技术 Story 在 Plan 阶段拆分）。

### 核心用户旅程（可选但强烈建议）

#### 旅程 1 - 列表缩略图快速显示

- **描述**：用户滚动时间轴列表，缩略图快速加载显示
- **成功信号**：缩略图在进入可视区域后 300ms 内显示，无白块或卡顿
- **验收场景**：
  1. **前提** 用户进入时间轴页面，**当** 列表滚动，照片进入可视区域，**则** 缩略图在 300ms 内显示（首帧）
  2. **前提** 缩略图已缓存，**当** 用户再次滚动到该照片，**则** 缩略图从缓存立即显示（< 50ms）

#### 旅程 2 - 大图原图高质量显示

- **描述**：用户点击照片进入大图浏览，原图快速加载并显示，支持缩放查看清晰细节
- **成功信号**：大图在 500ms 内显示首帧（屏幕尺寸），用户缩放时能看到更高清晰度的细节
- **验收场景**：
  1. **前提** 用户点击照片进入大图，**当** 大图页面打开，**则** 按屏幕尺寸缩放的原图在 500ms 内显示首帧
  2. **前提** 大图首帧显示后，**当** 用户双指缩放或双击放大，**则** 加载并显示更高清晰度的原图细节，无明显延迟

#### 旅程 3 - 加载失败友好提示

- **描述**：图片加载失败时，显示友好的错误占位符
- **成功信号**：用户看到破损图标而非白块或崩溃，应用记录失败日志
- **验收场景**：
  1. **前提** 图片文件损坏或无法解码，**当** 加载失败，**则** 显示错误占位符（破损图片图标），记录失败日志（文件路径、错误类型）
  2. **前提** 加载失败后，**当** 用户重新进入页面，**则** 再次尝试加载该图片

### 边界与异常场景（必填）

- **大量图片快速滚动** → 支持预加载下3屏和优先级队列，确保可视区域图片优先加载，快速滚动时取消已离开预加载范围的任务，内存不溢出
- **内存不足场景** → 自动淘汰旧缓存，降低缓存大小，记录低内存事件
- **磁盘缓存满** → 自动清理最旧的缓存文件，或限制缓存大小
- **图片解码失败** → 显示破损图标占位符，记录日志（文件路径、错误原因），不提供重试UI
- **缩略图与原图切换** → 大图浏览初始显示屏幕尺寸的图片，用户缩放时加载更高清晰度细节，过渡流畅无闪烁
- **并发加载** → 支持多个图片同时加载，线程池管理，避免阻塞 UI
- **应用在后台被杀死** → 磁盘缓存保留，重新打开应用时可直接使用
- **缓存数据损坏** → 检测到损坏时自动清理，重新加载
- **预加载策略** → 时间轴列表预加载下3屏缩略图（用户向下滚动时），大图浏览预加载前后各3张原图，确保快速切换时图片已加载完成

## FR / NFR *（必填）*

### FR（Functional Requirements）

> 规则：每条 FR 必须**可测试**，避免"提升体验/更快/更稳定"这类不可验证表述。

- **FR-001**：系统必须能够加载本地图片（通过 URI），支持 JPEG、PNG、HEIC、WebP 等常见格式
- **FR-002**：系统必须能够加载缩略图（低分辨率，用于列表显示，统一尺寸 256x256px，适用于时间轴列表、图集封面、缩图轴等所有场景）
- **FR-003**：系统必须能够加载原图，初始按屏幕尺寸缩放快速显示，支持用户手势缩放时加载并显示更高清晰度的原图细节
- **FR-004**：系统必须提供内存缓存（LRU 策略，最大 150MB），避免重复加载已显示的图片
- **FR-005**：系统必须提供磁盘缓存（LRU 策略，最大 500MB），减少重复解码
- **FR-006**：系统必须在图片加载失败时显示错误占位符（破损图片图标），不显示白块或崩溃
- **FR-007**：系统必须在图片加载过程中显示加载中占位符（灰色方块），供用户感知加载状态
- **FR-008**：系统必须支持预加载，时间轴列表场景预加载下3屏缩略图，大图浏览场景预加载前后各3张原图，优化浏览流畅度
- **FR-009**：系统必须支持用户手势缩放（双指缩放、双击缩放）时，加载并显示更高清晰度的原图，确保用户能查看清晰细节
- **FR-010**：系统必须提供统一的图片加载接口（如 `ImageLoader.load(uri, target, config)`），简化调用
- **FR-011**：系统必须在缓存接近上限时自动淘汰最旧的缓存项，避免缓存溢出

### NFR（Non-Functional Requirements）

> 规则：每条 NFR 必须**量化**并附带验收方式；细化评估在 Plan 阶段完成。

#### 性能（Performance）**（P0 关键关注点）**

- **NFR-PERF-001**：列表缩略图首帧显示延迟 < 300ms（P90），从图片进入可视区域开始计时，测试场景：10,000 张照片
- **NFR-PERF-002**：大图原图首帧显示时间 < 500ms（P90），从大图页面打开开始计时
- **NFR-PERF-003**：列表缩略图预加载时间 < 200ms（P90），下3屏内容在用户滚动到达前完成加载
- **NFR-PERF-004**：大图切换时，预加载的前后3张图片显示延迟 < 200ms（P90），确保快速滑动时流畅
- **NFR-PERF-005**：缓存命中时图片显示延迟 < 50ms（P90），从缓存读取到显示
- **NFR-PERF-006**：用户缩放时高清细节加载延迟 < 300ms（P90），从缩放手势结束到高清图片显示

#### 内存（Memory）

- **NFR-MEM-001**：图片缓存内存占用 < 150MB（峰值），使用 LRU 策略自动淘汰
- **NFR-MEM-002**：磁盘缓存占用 < 500MB（峰值），使用 LRU 策略自动淘汰
- **NFR-MEM-003**：图片加载过程中内存增量 < 100MB（峰值），大图预加载前后各3张时峰值内存控制在此范围内，加载完成后及时释放
- **NFR-MEM-004**：内存不足时（设备剩余内存 < 100MB），自动降低缓存大小至 50% 或清理缓存

#### 可靠性（Reliability）

- **NFR-REL-001**：图片加载成功率 > 99%（排除文件损坏和权限拒绝），在正常媒体文件场景下
- **NFR-REL-002**：缓存命中率 > 80%，在用户正常浏览场景下（重复查看已浏览照片）
- **NFR-REL-003**：加载失败时不崩溃，显示错误占位符并记录日志
- **NFR-REL-004**：磁盘缓存数据损坏时，自动检测并清理，不影响应用运行

#### 兼容性（Compatibility）

- **NFR-COMPAT-001**：支持 Android 10+ (API Level 29+) 所有版本的图片解码 API（BitmapFactory, ImageDecoder）
- **NFR-COMPAT-002**：支持常见图片格式（JPEG, PNG, HEIC, WebP, GIF），在主流设备上正常显示
- **NFR-COMPAT-003**：在低端设备（2GB RAM）上可正常运行，内存占用不超标，无 OOM

#### 可观测性（Observability）

- **NFR-OBS-001**：关键操作需埋点（图片加载时间、缓存命中率、加载失败次数），所有用户固定 10% 采样率
- **NFR-OBS-002**：加载失败需记录日志（URI、错误类型、设备信息），供问题排查
- **NFR-OBS-003**：内存不足事件需埋点统计（触发频次、设备 RAM），供性能分析

#### 安全与隐私（Security/Privacy）

- **NFR-SEC-001**：缓存的图片数据不上传至服务器，仅本地存储
- **NFR-SEC-002**：磁盘缓存存储在应用私有目录，其他应用无法访问

## 验收标准（Feature Level）*（必填）*

- **AC-001**：在 10,000 张照片的时间轴列表中，缩略图首帧显示延迟 < 300ms（P90）（关联: FR-002, NFR-PERF-001）
- **AC-002**：在大图浏览中，原图首帧显示时间 < 500ms（P90）（关联: FR-003, NFR-PERF-002）
- **AC-003**：内存缓存命中时，图片显示延迟 < 50ms（关联: FR-004, NFR-PERF-005）
- **AC-004**：缓存命中率 > 80%，在用户重复浏览场景下（关联: FR-004, FR-005, NFR-REL-002）
- **AC-005**：图片加载失败时，显示破损图标占位符，应用不崩溃（关联: FR-006, NFR-REL-003）
- **AC-006**：内存缓存占用 < 150MB，磁盘缓存 < 500MB（关联: FR-004, FR-005, NFR-MEM-001, NFR-MEM-002）
- **AC-007**：大图切换时，预加载的前后3张图片显示延迟 < 200ms；列表滚动时下3屏缩略图在到达前完成加载（关联: FR-008, NFR-PERF-003, NFR-PERF-004）
- **AC-008**：图片加载时间和缓存命中率埋点正常上报（关联: NFR-OBS-001）
- **AC-009**：在低端设备（2GB RAM）上，图片加载功能正常，无 OOM（关联: NFR-COMPAT-003, NFR-MEM-004）
- **AC-010**：用户缩放大图时，高清细节在 300ms 内显示（关联: FR-009, NFR-PERF-006）
- **AC-011**：其他 Feature 可通过 ImageLoader 接口成功加载图片（关联: FR-010）

## 核心实体（如涉及数据则必填）

- **ImageLoadRequest（图片加载请求）**：代表一次图片加载请求，包含属性：
  - `uri`: Uri - 图片 URI（本地媒体 URI）
  - `targetView`: ImageView? - 目标 ImageView（可选，用于直接显示）
  - `size`: Size - 目标尺寸（256x256 缩略图用于所有列表场景，屏幕尺寸用于大图初始显示，原图尺寸用于缩放后的高清显示）
  - `placeholder`: Drawable? - 占位符（加载中显示灰色方块）
  - `errorPlaceholder`: Drawable? - 错误占位符（加载失败显示破损图片图标）
  - `priority`: Priority - 优先级（HIGH/NORMAL/LOW，用于队列调度）
  - `cacheStrategy`: CacheStrategy - 缓存策略（ALL/MEMORY_ONLY/DISK_ONLY/NONE）

- **CacheConfig（缓存配置）**：缓存策略配置，包含属性：
  - `memoryCacheSize`: Long - 内存缓存大小（默认 150MB）
  - `diskCacheSize`: Long - 磁盘缓存大小（默认 500MB）
  - `cacheDirectory`: File - 磁盘缓存目录（应用私有目录）
  - `maxCacheAge`: Duration - 缓存最大保留时间（如 7 天）

- **LoadResult（加载结果）**：图片加载结果，枚举值：
  - `SUCCESS` - 加载成功
  - `ERROR_FILE_NOT_FOUND` - 文件不存在
  - `ERROR_DECODE_FAILED` - 解码失败
  - `ERROR_CACHE_MISS` - 缓存未命中（仅统计用）
  - `ERROR_OUT_OF_MEMORY` - 内存不足

## 假设与约束 *（必填）*

- **假设**：
  - **假设 1**：选择 Glide 或 Coil 作为底层图片加载库，若库不可用则需要降级方案（影响：可能需要自研简化版图片加载器）
  - **假设 2**：设备有足够的磁盘空间用于缓存（至少 500MB），若空间不足则降级为仅内存缓存（影响：缓存命中率下降，加载速度变慢）
  - **假设 3**：用户浏览行为符合正常模式（重复查看、顺序浏览），若随机跳转则缓存命中率下降（影响：预加载策略可能失效）
  - **假设 4**：图片文件格式符合标准规范，若格式异常则解码可能失败（影响：显示错误占位符，记录日志）
- **约束**：
  - **性能约束（P0 关键）**：列表缩略图首帧 < 300ms，大图首帧 < 500ms，缓存命中 < 50ms（关联 EPIC-NFR-PERF）
  - **内存约束**：图片缓存 < 150MB，磁盘缓存 < 500MB，加载增量 < 100MB（关联 EPIC-NFR-MEM）
  - **技术约束**：必须使用成熟的图片加载库（Glide/Coil），不自研底层解码逻辑
  - **兼容性约束**：支持 Android 10-14，支持常见图片格式（JPEG, PNG, HEIC, WebP）
  - **可靠性约束**：加载成功率 > 99%，缓存命中率 > 80%

## 技术选型（Plan 阶段确定）

> 说明：以下选型建议在 Plan 阶段评估确定，此处仅作为候选方案记录。

### 候选方案：Glide vs Coil

| 特性 | Glide | Coil |
|---|---|---|
| 成熟度 | 非常成熟，广泛使用 | 较新，Kotlin-first |
| 性能 | 优秀，经过充分优化 | 优秀，使用 Coroutines |
| 内存管理 | 内置 LRU 缓存，可配置 | 内置 LRU 缓存，轻量 |
| API 易用性 | 灵活但略复杂 | 简洁，Kotlin 友好 |
| 社区支持 | 庞大社区，丰富文档 | 活跃但相对较小 |
| 依赖大小 | 较大（~500KB） | 较小（~200KB） |

**建议**：优先选择 Coil（Kotlin-first，轻量，API 简洁），若遇到兼容性问题则降级到 Glide。

## 澄清内容

### 会话 2026-01-29

- 问题：缩略图尺寸策略 - 不同使用场景（时间轴列表、图集封面、缩图轴）是否需要不同的缩略图尺寸？ → 答案：统一使用 256x256px
- 问题：预加载范围定义 - 时间轴列表和大图浏览场景的预加载范围分别是多少？ → 答案：列表预加载下3屏，大图预加载前后各3张
- 问题：加载失败重试机制 - 本地图片加载失败时，是否支持自动重试或手动重试UI？ → 答案：仅记录日志，不自动重试，不提供手动重试UI
- 问题：占位符显示策略 - 加载中和加载失败时分别显示什么样的占位符？ → 答案：加载中显示灰色方块，错误显示破损图标
- 问题：大图显示尺寸策略 - 大图浏览时是保持原图尺寸还是缩放到屏幕尺寸？用户放大时如何处理？ → 答案：初始缩放到屏幕尺寸快速显示，支持用户手势缩放时加载并显示更高清晰度的原图细节
- 问题：性能埋点采样率策略 - 埋点采样是所有用户固定 10%，还是需要分场景或支持动态调整？ → 答案：所有用户固定 10% 采样

## 变更记录

| 版本 | 日期 | 变更摘要 | 影响分析 | 是否需要回滚设计 |
|---|---|---|---|---|
| v0.1.0 | 2026-01-29 | 初始版本，明确图片加载与显示速度为 P0 关键关注点 | 无 | 否 |
