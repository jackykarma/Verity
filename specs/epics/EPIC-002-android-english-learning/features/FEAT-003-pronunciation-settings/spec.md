# Feature 规格说明：设置（含英式/美式发音切换）

**Epic**：EPIC-002 - Android 端英语学习 APP
**Feature 类型**：Product Feature
**Feature ID**：FEAT-003
**Feature Version**：v0.1.0
**EPIC 分支**：`epic/EPIC-002-android-english-learning`
**Feature 目录**：`specs/epics/EPIC-002-android-english-learning/features/FEAT-003-pronunciation-settings/`
**创建时间**：2026-01-25
**状态**：草稿
**输入**：用户描述：`"设置：提供发音偏好（英式/美式）的切换、持久化与查询，以及基础设置入口。"`

## 背景与价值 *（必填）*

- **背景**：单词、听力、口语等模块均依赖发音输出，若各模块自行维护偏好会导致不一致与返工；用户需在一处统一配置英式/美式发音。
- **目标**：提供发音偏好（英式/美式）的 UI 切换、持久化与查询，以及基础设置入口与导航，供使用发音的模块读取并生效。
- **价值**：统一发音偏好为跨模块能力，先行交付可减少后续返工；用户可在一处切换并在全应用生效。
- **范围（In Scope）**：发音偏好（英式/美式）的 UI 切换、持久化与提供查询；基础设置入口与导航。
- **范围外（Out of Scope）**：主题、字体、通知、账号、多语种等其它设置；TTS 引擎的实现与选型归属能力层或各业务 Feature。

## 澄清内容

### 会话 2026-01-25

- 问题：持久化键名与读取契约的归属 → 答案：本 spec 确定键名、枚举取值与缺省值；Plan 只做实现与存储选型。
- 问题：切换的「完成」定义 → 答案：选即生效：选择英式/美式后立即落盘，无需额外「保存」或「确认」。
- 问题：设置页的加载与空状态 → 答案：无 loading（读很快），首次默认美式且勾选。
- 问题：「中端机」的定义 → 答案：与 EPIC 一致，本 spec 不单独定义；由 Plan / 测试策略或 epic 约定补充。
- 问题：切换后、未落盘前下游模块的读取语义 → 答案：以内存/工作副本为准：选择后先更新内存，异步落盘；下游读时返回内存值（强一致）。

## 依赖关系 *（必填）*

- **上游依赖**：无。本地存储（如 SharedPreferences / DataStore）用于持久化；TTS 或语音引擎的选型与实现由能力层或各业务 Feature 负责，本 Feature 仅提供偏好键与读取契约。
- **下游影响**：单词记忆、听力训练、阅读（若朗读）、口语训练等模块；上述模块需在调用 TTS/音频时读取本 Feature 提供的偏好并传入对应英/美参数。
- **外部依赖故障模式**：本地存储不可用时，可降级为内存中的进程内缺省值（如美式）；存储恢复后下次写入可纠正。

## 验收与场景 *（必填）*

### 核心用户旅程（可选但强烈建议）

#### 旅程 1 - 切换发音偏好并生效

- **描述**：用户进入设置，在英式/美式间切换，退出或切换页面后偏好仍保持；使用发音的模块在下次播放或一次刷新内采用新偏好。
- **成功信号**：设置页展示当前偏好并可切换；退出应用再进入后偏好仍为该值；单词/听力/口语等模块能读到最新偏好并用于播放。
- **验收场景**：
  1. **前提** 偏好为美式，**当** 用户在设置中切换为英式并退出设置，**则** 偏好持久化为英式，且可被其它模块查询到
  2. **前提** 偏好为英式，**当** 用户完全退出应用后再启动，**则** 偏好仍为英式

### 边界与异常场景（必填）

- 首次安装、无历史存储 → 使用缺省偏好（美式），**设置页默认美式且勾选**，不展示 loading；写入成功后视为已设置。偏好读取在 NFR-PERF-001 约束内（≤50ms）呈现。
- 存储写入失败（如磁盘满）→ 本次修改可不持久化，进程内可暂时生效；记日志，下次启动回退缺省值
- 应用被杀死后重启 → 以持久化值为准；若读不到则用缺省值并写入
- 并发/生命周期：**选择后先更新内存、异步落盘**；**下游读取以内存/工作副本为准**，选后即可读到新值（强一致）；进程重启后以持久化值为准。多界面同时读时，以当前内存值为准。

## FR / NFR *（必填）*

### FR（Functional Requirements）

- **FR-001**：用户必须在设置界面中能选择发音偏好为「英式」或「美式」；**选即生效**：选择后立即触发持久化，无需「保存」或「确认」；交互方式可为单选、开关等。
- **FR-002**：系统必须在用户选择后（选即生效）立即将偏好持久化到本地；应用进程退出后再启动，偏好仍为上次用户所选（或缺省美式）。
- **FR-003**：系统必须对外提供查询接口（或等价契约），使单词、听力、阅读（若朗读）、口语等模块能获取当前偏好（英式/美式），用于 TTS/音频调用。
- **FR-004**：应用必须提供基础设置入口与导航（如设置图标、设置页、从设置返回主页/上一级），使用户能进入发音偏好设置。

### NFR（Non-Functional Requirements）

#### 性能（Performance）

- **NFR-PERF-001**：设置页冷启或从主页进入设置到首屏可交互 ≤ 500ms（中端机）；偏好读取接口单次调用 ≤ 50ms；用户选择后立即触发持久化写入，可异步落盘且不阻塞 UI。

#### 功耗（Power）

- **NFR-POWER-001**：本 Feature 不引入常驻后台任务；持久化与读取为按需、低频，对整体功耗影响可忽略；不单独设功耗预算。

#### 内存（Memory）

- **NFR-MEM-001**：偏好相关内存占用可忽略（键值级）；不新增大对象或缓存。

#### 安全与隐私（Security/Privacy）

- **NFR-SEC-001**：仅存储发音偏好枚举（英式/美式），不涉及用户身份、语音或敏感数据；按应用现有数据存储策略（本地仅本机）即可。

#### 可观测性（Observability）

- **NFR-OBS-001**：持久化写入失败时记日志；可选：读取命中缺省值时记一条调试日志；首版可不做埋点，按 EPIC 轻量可观测执行。

#### 可靠性（Reliability）

- **NFR-REL-001**：读不到持久化值时回退缺省值（美式），不因本 Feature 导致崩溃或阻塞启动；写入失败时进程内可暂时生效，不误导下游模块。

## 验收标准（Feature Level）*（必填）*

- **AC-001**：用户可在设置中完成英式↔美式切换，退出设置或应用后再次进入， preference 仍为上次所选（FR-001、FR-002）。
- **AC-002**：通过提供的查询接口或契约，单词/听力/口语中至少一个模块能正确读到当前偏好并用于播放（FR-003）。
- **AC-003**：从主页或主导航可进入设置页，并可从设置页返回（FR-004）。
- **AC-004**：设置页进入至可操作 ≤ 500ms，偏好读取 ≤ 50ms（NFR-PERF-001）。

## 核心实体（如涉及数据则必填）

- **发音偏好（PronunciationPreference）**：枚举，取值英式（British）或美式（American）。**持久化键名**：`pronunciation_preference`。**枚举取值（存储）**：`british`（英式）、`american`（美式），字符串。**缺省值**：`american`（美式）；读不到或非法值时按缺省处理。**读取契约**：本 Feature 提供查询接口，返回当前偏好（上述字符串）；**以内存/工作副本为读取源**，选择后先更新内存、异步落盘，下游读时返回内存值（强一致），选后即可在它模块生效。各模块在调用 TTS/音频时传入该值。Plan 仅负责实现与存储选型（如 SharedPreferences/DataStore）。

## 假设与约束 *（必填）*

- **假设**：用户具备基础操作能力；设备提供可用本地存储；TTS/语音引擎的英/美实现由能力层或各业务 Feature 集成，本 Feature 不实现 TTS；若假设不成立（如存储不可用），则回退缺省值并记日志，不阻塞启动。
- **约束**：Android 8.0+ / API 26+；偏好仅本地存储，不做云端同步；与 EPIC 一致：发音缺省为美式。**「中端机」**：与 EPIC 或 Plan/测试策略约定，本 spec 不单独定义。

## 需求追溯（预留，Plan 后填写）

| FR/NFR ID | 计划覆盖的 Story ID（Plan） | 任务覆盖（Tasks） | 备注 |
|---|---|---|---|
| FR-001 | ST-??? | T??? |  |
| FR-002 | ST-??? | T??? |  |
| FR-003 | ST-??? | T??? |  |
| FR-004 | ST-??? | T??? |  |
| NFR-PERF-001 | ST-??? | T??? |  |
| NFR-POWER-001 | — | — | 按需 |
| NFR-MEM-001 | — | — | 按需 |
| NFR-SEC-001 | ST-??? | T??? |  |
| NFR-OBS-001 | ST-??? | T??? |  |
| NFR-REL-001 | ST-??? | T??? |  |

## 变更记录（增量变更）

| 版本 | 日期 | 变更范围 | 变更摘要 | 影响 | 是否需要回滚 |
|---|---|---|---|---|---|
| v0.1.0 | 2026-01-25 | 全文 | 初稿，/speckit.feature 创建设置 Feature | — | 否 |
