# Plan Template 使用指南

> 本文档总结 `plan-template.md` 的核心概念、最佳实践和使用方法。

**版本**: v1.0  
**更新日期**: 2026-01-28

---

## 目录

- [Plan-A 与 Plan-B 的关系](#plan-a-与-plan-b-的关系)
- [Feature 到 Story 的拆分策略](#feature-到-story-的拆分策略)
- [评估体系详解](#评估体系详解)
  - [功耗评估 (A7)](#功耗评估-a7)
  - [性能评估 (A8)](#性能评估-a8)
  - [内存评估 (A9)](#内存评估-a9)
  - [安全评估 (A10)](#安全评估-a10)
  - [兼容性评估 (A11)](#兼容性评估-a11)

---

## Plan-A 与 Plan-B 的关系

### 核心定位

| 维度 | Plan-A | Plan-B |
|---|---|---|
| **定位** | 工程决策 & 风险评估 | 技术规约 & 实现约束 |
| **视角** | **为什么**这样设计？**怎么做**？ | **具体约束**是什么？如何落地？ |
| **层次** | 架构设计、方案选型、风险评估 | 技术细节、实现规约、契约定义 |
| **产出** | 架构图、类图、时序图、流程图 | 数据模型、接口契约、分层规约 |
| **受众** | 架构师、技术评审、团队理解 | 开发人员、实现落码、联调对接 |

### Plan-A 核心内容

```
A0. 领域概念               → 统一命名、术语权威
A1. 技术选型               → 候选方案对比、决策理由
A2. 全景架构（0层）        → Feature 边界、外部依赖
A3. 内部设计（1层）        → 组件拆分、类图、时序图、流程图
A4. 技术风险               → 风险识别、消解策略
A5. 边界异常               → 数据/状态/并发/用户行为边界
A6-A11. 评估维度           → 算法/功耗/性能/内存/安全/兼容性

Story Breakdown            → Feature 拆分成 Story（技术视角）
Story Detailed Design (L2) → Story 级细化设计
```

### Plan-B 核心内容

```
B0. Plan-A ↔ Plan-B 一致性互校  → 确保设计与规约一致
B1. 技术背景                    → 语言版本、依赖库、目标平台
B2. 架构细化                    → 分层约束、线程模型、错误规范
B3. 数据模型                    → 数据库表结构、字段、迁移策略
B4. 接口规范/协议               → API 契约、输入输出、错误码
B5. 合规性检查                  → 合规关卡、整改项
B6-B7. 项目结构、源代码结构     → 目录结构、文件组织
```

### 内容重叠与互补

| 内容 | Plan-A（设计层） | Plan-B（规约层） | 关系 |
|---|---|---|---|
| **架构** | A2/A3：架构图、组件拆分、协作方式 | B2：分层约束、线程模型、错误规范 | **互补**：A 说"是什么样"，B 说"必须遵循什么" |
| **外部依赖** | A2.2：外部依赖清单、故障模式 | B4.2：依赖接口契约、调用约束 | **细化**：A 识别依赖，B 定义契约 |
| **数据模型** | A0：领域概念（业务视角） | B3：数据模型（物理结构） | **映射**：A 定义概念，B 定义表结构 |
| **接口** | A3：组件接口（类图中的接口） | B4：接口契约（API 规范） | **细化**：A 定义接口关系，B 定义调用细节 |

### B0：一致性互校机制

确保 Plan-A 和 Plan-B **不矛盾、有落点**：

| Plan-A（决策/假设/约束） | Plan-B（落点） | 自检规则 |
|---|---|---|
| A0 领域概念命名 | B3/B4/Story | 术语一致；中英文/代码名一致 |
| A1 技术选型 | B1/B2 | 依赖与分层规约匹配；无矛盾 |
| A2 外部依赖与故障策略 | B4.2 | 超时/重试/降级/错误语义一致 |
| A3 数据一致性/缓存假设 | B3.1/B3.2 | SoR、缓存、迁移策略一致 |
| A3 错误与失败传播 | B2/B4 | 错误分类/错误码/用户提示一致 |

### 工作流程

1. **先写 Plan-A**：架构设计、方案选型、风险评估
2. **评审 Plan-A**：团队理解架构、识别风险
3. **再写 Plan-B**：技术规约、数据模型、接口契约
4. **执行 B0 互校**：确保 Plan-A 和 Plan-B 一致
5. **开始实现**：开发人员按 Plan-B 落码

---

## Feature 到 Story 的拆分策略

### 核心概念区分

```
Feature (需求视角)               Story (技术视角)
├─ 面向用户价值                 ├─ 面向技术实现
├─ 必须可独立交付               ├─ 不要求独立交付
├─ 有明确的业务验收标准         ├─ 有技术验收标准
└─ 对应 PRD 中的功能点          └─ 按技术边界拆分 Feature
```

### Story 类型（必须标注）

| Story 类型 | 技术定位 | 是否独立交付 | 典型场景 |
|---|---|---|---|
| **Infrastructure** | 基础设施 | ❌ | 网络框架、数据库、日志系统 |
| **Design-Enabler** | 设计使能 | ❌ | Repository、ViewModel、Domain 模型 |
| **Functional** | 功能实现 | ⚠️ (部分) | UI 界面、业务逻辑、用户交互 |
| **Optimization** | 优化改进 | ❌ | 性能优化、内存优化、重构 |

### 工作量约束

- **单个 Story 预估工作量**: ≤ **10 人天**（约 2 周）
- **建议范围**: 3-8 人天
- **超过 10 人天**: 必须继续拆分

### 五种拆分策略

#### 策略 1: 按架构层次拆分（水平拆分）

适用于：新功能开发、模块重构、各层可并行

```
ST-001: Data 层 - 数据存储与网络请求 (Infrastructure, 3-5天)
ST-002: Domain 层 - 业务逻辑与用例 (Design-Enabler, 3-5天)
ST-003: UI 层 - 界面展示与交互 (Functional, 4-6天)
```

**优点**: 各层独立开发，适合团队并行  
**注意**: 需定义清晰的接口契约，ST-003 完成后 Feature 才可交付

#### 策略 2: Walking Skeleton + 增量（端到端拆分）

适用于：复杂功能、高不确定性、需快速验证端到端链路

```
ST-001: 搭建端到端骨架 (Infrastructure, 3-5天)
  └─ 最小可用链路：UI → Domain → Data（Mock 数据）
  
ST-002: 完善核心功能 (Functional, 4-6天)
  └─ 接入真实数据、错误处理、状态管理
  
ST-003: 扩展与优化 (Functional/Optimization, 3-5天)
  └─ 高级功能、性能优化、边界处理
```

**优点**: 快速验证技术方案，降低风险  
**注意**: ST-001 虽不可交付，但能跑通完整链路

#### 策略 3: 按风险隔离拆分

适用于：技术风险高、依赖第三方 SDK、算法/性能敏感

```
ST-001: 高风险技术预研 (Infrastructure, 3-5天, RISK-HIGH)
  └─ SDK 选型、兼容性测试、降级方案
  
ST-002: 核心功能实现 (Functional, 4-6天)
  └─ 依赖 ST-001，实现业务逻辑
  
ST-003: 完善与优化 (Optimization, 2-4天)
  └─ 性能优化、边界处理
```

**优点**: 先攻克风险，避免返工  
**注意**: ST-001 必须产出明确的技术决策与可用方案

#### 策略 4: 按依赖关系拆分（自底向上）

适用于：基础设施升级、框架迁移、共享能力建设

```
ST-001: 基础设施搭建 (Infrastructure, 3-5天)
  └─ 网络框架、数据库、日志系统
  
ST-002: 核心模块迁移 (Design-Enabler, 4-6天)
  └─ 依赖 ST-001，迁移关键业务模块
  
ST-003: 批量迁移与清理 (Functional, 4-6天)
  └─ 依赖 ST-002，迁移剩余模块，移除旧框架
```

**优点**: 依赖关系清晰，便于分阶段推进  
**注意**: ST-001/ST-002 不可交付，ST-003 完成后 Feature 才可交付

#### 策略 5: 按场景/流程拆分（垂直拆分）

适用于：复杂流程、多个子场景、可独立验证的功能点

```
ST-001: 主流程实现 (Functional, 5-7天)
  └─ 正常路径：用户操作 → 业务处理 → 结果展示
  
ST-002: 异常处理 (Functional, 3-5天)
  └─ 网络异常、数据异常、用户取消等
  
ST-003: 扩展场景 (Functional, 3-5天)
  └─ 高级功能、特殊场景、边界情况
```

**优点**: 每个 Story 相对完整，便于验收  
**注意**: 避免场景过于零碎，保持合理粒度

### 拆分自检清单

**拆分前检查**:
- [ ] Story 预估工作量 ≤ 10 人天？
- [ ] Story 在 A3.1 组件边界内？（不得新增组件）
- [ ] Story 依赖关系清晰？（无循环依赖）
- [ ] Story 有明确的技术验收标准？（DoD 可验证）
- [ ] Story 覆盖至少 1 个 FR 或 NFR？

**拆分粒度检查**:
- [ ] 若 Story > 10 人天：继续拆分
- [ ] 若 Story < 2 人天且无法独立验收：考虑合并
- [ ] 若 Story 包含"和""或""以及"等连接词过多：可能粒度过粗

---

## 评估体系详解

### 功耗评估 (A7)

#### 计算公式

```
单次功耗 (mAh) = 平均电流增量 (mA) × 使用时长 (秒) / 3600

每日功耗增量 (mAh) = 单次功耗 × 每日使用次数 × 功能渗透率 / 5%

温升 (°C) ≈ (电流增量 (mA) / 1000 × 3.7V) × 热阻 (8°C/W) × 修正系数
  - 修正系数：短时操作（<10s）约 0.4，持续操作（>1min）约 1.0
```

#### Top 5% 重度用户模型

| 维度 | 定义 |
|---|---|
| 设备型号 | 中端机型，4000mAh 电池 |
| 使用频次 | 每天使用功能 X 次 |
| 使用场景 | 前台使用/后台运行 |

#### 场景评估示例

| 场景 | 电流 | 时长 | 频次 | 每日功耗 | 温升 | 达标 |
|---|---|---|---|---|---|---|
| 启动功能 | 30mA | 5秒 | 3次 | 0.025mAh | 0.36°C | ✅ |
| 后台同步 | 15mA | 10秒 | 8次 | 6.72mAh | 0.18°C | ✅ |

#### 验收标准

- **每日功耗增量**: ≤ 10 mAh
- **单场景温升**: ≤ **0.5°C**（任何场景）
- **失败处置**: 超标必须优化，不得上线

---

### 性能评估 (A8)

#### 测试设备基线

| 维度 | 定义 |
|---|---|
| 设备型号 | 小米 11（中端机型）|
| 系统版本 | Android 12 |
| 网络环境 | 4G 良好信号 |

#### 性能场景与指标

##### 启动/加载场景

| 场景 | 指标 | 验收标准 (p95) |
|---|---|---|
| 冷启动 | 启动耗时 | ≤ 2000ms |
| 热启动 | 启动耗时 | ≤ 1000ms |
| 页面首屏加载 (TTI) | 加载耗时 | ≤ 1000ms |

##### UI 交互场景（通用标准）

> **所有点击、滑动、输入、动画等交互统一使用以下标准**：

| 指标类型 | 验收标准 |
|---|---|
| 点击/输入响应 (p95) | ≤ 200ms |
| 页面切换/动画流畅度 | 平均 ≥ 55fps，p95 ≥ 50fps |
| 卡顿率 (Jank Rate) | ≤ 5% |

**本功能涉及的 UI 交互场景**（列出关键场景即可）:
- 商品列表滑动 → 遵循通用标准
- 页面切换动画 → 遵循通用标准
- 搜索输入响应 → 遵循通用标准

##### 后台任务场景

| 场景 | 验收标准 (p95) |
|---|---|
| 后台数据同步 | ≤ 30s |
| 文件下载/上传 | 根据文件大小 |

**约束**: CPU 占用平均 ≤ 10%

#### 降级策略

| 触发条件 | 降级策略 |
|---|---|
| 低端设备 | 降低动画帧率、简化 UI、减少并发 |
| 弱网环境（< 100KB/s） | 启用缓存、降低图片质量 |
| 高负载（CPU > 80%） | 延迟非关键任务、降低刷新频率 |

---

### 内存评估 (A9)

#### 测试设备基线

| 维度 | 定义 |
|---|---|
| 设备型号 | 小米 11，8GB RAM |
| 测试场景 | 前台使用 + 后台驻留 + 生命周期切换 |

#### 内存场景与指标

| 场景 | 指标 | 验收标准 | 实测 |
|---|---|---|---|
| 前台正常使用 | 内存增量 (PSS) | ≤ 50MB | [实测] |
| 前台重度使用（峰值） | 内存增量 (PSS) | ≤ 100MB | [实测] |
| 后台驻留 | 内存占用 | ≤ 20MB | [实测] |
| 长时间使用（30分钟） | 内存趋势 | 无持续增长 | [实测] |
| 内存泄漏检测 | 反复进入退出 10 次 | 回到 Baseline ±5MB | [实测] |
| 内存抖动 | GC 频率 | ≤ 10 次/分钟 | [实测] |

#### 内存泄漏风险点

| 风险点 | 典型原因 | 预防措施 |
|---|---|---|
| Activity/Fragment 泄漏 | 静态引用、单例持有、监听器未移除 | 使用 ApplicationContext、onDestroy 取消注册 |
| Bitmap 泄漏 | 缓存策略不当 | 使用图片库（Glide/Coil）、LRU 缓存 |
| 线程泄漏 | AsyncTask/Thread 持有 Activity | 使用协程、及时取消 |
| 集合类泄漏 | Map/List 无限增长 | 使用 LRU、限制大小 |

#### 降级策略

| 触发条件 | 降级策略 |
|---|---|
| 可用内存 < 200MB | 清理缓存 |
| 可用内存 < 100MB | 停止预加载、降低图片质量 |
| 低内存设备（< 4GB RAM） | 降低缓存大小、减少并发 |
| onTrimMemory 回调 | 根据级别清理缓存 |

**失败处置**: 内存增量超标（>100MB）或内存泄漏，必须修复，不得上线

---

### 安全评估 (A10)

#### 数据安全

| 安全点 | 防护措施 | 验收标准 |
|---|---|---|
| 敏感数据存储 | 加密存储（AES-256/Keystore） | 无明文密码/Token |
| 数据传输 | HTTPS + 证书校验 | 所有接口 HTTPS |
| 日志安全 | 敏感字段脱敏 | Release 无敏感日志 |

#### 权限安全

| 权限类型 | 使用场景 | 申请时机 | 拒绝后处理 |
|---|---|---|---|
| 位置权限 | [场景] | 首次使用时 | 功能降级/提示 |
| 存储权限 | [场景] | 首次使用时 | 功能降级/提示 |

**原则**: 最小权限、运行时申请、拒绝后降级

#### 代码安全 & 合规性

- **代码混淆**: ProGuard/R8 混淆（Release 版本）
- **合规性**: GDPR/个人信息保护法（隐私政策 + 用户同意）

---

### 兼容性评估 (A11)

#### 系统版本兼容

| 平台 | 支持范围 | 测试覆盖 |
|---|---|---|
| Android | API 24+ (Android 7.0+) | API 24, 28, 31, 33 |
| iOS | iOS 13+ | iOS 13, 15, 16 |

#### 设备兼容

| 设备类型 | 测试机型 | 降级方案 |
|---|---|---|
| 低端机（2GB RAM） | 小米 Redmi 9A | 降低图片质量、关闭动画 |
| 中端机（6GB RAM） | 小米 11 | 无需降级 |
| 高端机/折叠屏/平板 | [机型] | 适配大屏/多窗口 |

#### 屏幕兼容

- **适配要点**: 使用 dp/sp、响应式布局、适配刘海屏/挖孔屏（WindowInsets）
- **测试覆盖**: 小屏（720p）、常规屏（1080p）、全面屏、折叠屏

#### 网络兼容

| 网络环境 | 降级方案 |
|---|---|
| 弱网（< 100KB/s） | 启用缓存、降低图片质量 |
| 断网 | 提示无网络、显示缓存数据 |

#### 数据库升级兼容

##### 升级场景

| 升级路径 | 变更内容 | 升级策略 |
|---|---|---|
| v1 → v2 | 新增表/字段 | Migration 自动迁移 |
| v1 → v2 | 删除表/字段 | 迁移前备份 + 数据迁移 |
| v1 → v3（跨版本） | 多次变更 | 支持连续 Migration 链 |

##### 兼容性验收

- ✅ **向前兼容**: 老版本 DB → 新版本，数据正常迁移
- ✅ **降级兼容**: 新版本 DB 可被老版本识别（保留旧字段）
- ✅ **跨版本兼容**: 支持跨版本升级（v1 → v3）
- ✅ **失败处理**: Migration 失败时，保留原数据不损坏

##### 测试场景

| 测试场景 | 验收标准 |
|---|---|
| 老用户升级（v1 → v2） | 数据完整、功能正常 |
| 跨版本升级（v1 → v3） | 数据完整、功能正常 |
| Migration 失败 | 不损坏原数据、提示用户 |

#### APK 版本升级兼容

##### 升级路径

| 升级路径 | 变更类型 | 兼容性要求 |
|---|---|---|
| v1.0 → v1.1 | Bug 修复、功能增强 | 完全兼容 |
| v1.0 → v2.0 | 新功能、架构升级 | 向后兼容 |
| v1.0 → v3.0 | 跨版本升级 | 支持跨版本升级 |

##### 兼容性检查清单

**数据兼容**:
- [ ] SharedPreferences / DataStore 能正常读取
- [ ] 数据库能正常升级
- [ ] 本地文件能正常访问

**功能兼容**:
- [ ] 核心功能正常（登录、主流程）
- [ ] 用户设置保留
- [ ] 历史数据正常展示

**UI 兼容**:
- [ ] 启动画面正常（无崩溃/白屏）
- [ ] 导航流程正常

**权限兼容**:
- [ ] 新增权限在合适时机申请
- [ ] 老版本已授予的权限保留

##### 灰度策略

| 灰度阶段 | 覆盖用户 | 观测指标 | 回滚条件 |
|---|---|---|---|
| 灰度 1% | 新用户 + 活跃老用户 | Crash 率 < 0.5% | Crash 率 > 1% |
| 灰度 10% | 随机抽样 | 核心流程正常 | 成功率 < 95% |
| 灰度 50% | 随机抽样 | 用户反馈正常 | 严重 Bug > 5 个 |
| 全量 100% | 所有用户 | 持续监控 | 随时回滚 |

##### 测试场景

| 测试场景 | 验收标准 |
|---|---|
| 覆盖安装升级 | 功能正常、数据保留 |
| 跨版本升级（v1 → v3） | 功能正常、数据完整 |
| 降级安装（v2 → v1） | 提示不支持或兼容处理 |
| 杀进程后重启 | 状态恢复正常 |

---

## 附录

### 常见问题

**Q: Story 是否必须独立交付？**  
A: 否。Story 是技术视角的拆分，允许依赖关系。只有 Feature 必须可独立交付用户价值。

**Q: Plan-A 和 Plan-B 可以合并吗？**  
A: 不建议。Plan-A 面向架构设计（为什么），Plan-B 面向实现规约（怎么做），分开更清晰。通过 B0 互校保持一致。

**Q: 如何判断 Story 拆分粒度是否合理？**  
A: 单个 Story ≤ 10 人天，≥ 2 人天。超过则继续拆分，过小则考虑合并。

**Q: UI 性能是否需要每个操作都单独评估？**  
A: 否。UI 交互统一使用通用标准（响应 ≤ 200ms，帧率 ≥ 55fps，卡顿率 ≤ 5%），只需列出关键场景即可。

**Q: 数据库升级失败如何处理？**  
A: Migration 失败时，保留原数据不损坏，提示用户，不得强制升级导致数据丢失。

---

## 参考资源

- `.specify/templates/plan-template.md` - Plan 模板完整版
- `.specify/templates/tasks-template.md` - Tasks 拆解模板
- `.specify/templates/spec-template.md` - Spec 规格说明模板
- `docs/speckit-best-practices.md` - SpecKit 最佳实践

---

**维护者**: Verity Team  
**最后更新**: 2026-01-28
