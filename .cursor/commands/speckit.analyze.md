---
description: 在任务生成完成后，对spec.md、plan.md和tasks.md这三类核心工件进行非破坏性的跨工件一致性与质量分析。
---

## 用户输入

```text
$ARGUMENTS
```

在继续执行前，你**必须**考量用户输入的内容（若不为空）。

## 目标

在项目实施前，识别三类核心工件（`spec.md`、`plan.md`、`tasks.md`）中存在的不一致、重复、模糊不清以及描述不充分的问题。该命令**仅允许**在 `/speckit.tasks` 成功生成完整的 `tasks.md` 文件后运行。

## 操作约束

**严格只读**：请勿修改任何文件。输出结构化的分析报告。可提供可选的整改方案（需用户明确批准后，方可手动触发后续的编辑命令）。

**章程权威性**：项目章程（`.specify/memory/constitution.md`）在本次分析范围内**不可协商**。违反章程的问题自动判定为CRITICAL（严重）级别，需调整规格说明（spec）、计划（plan）或任务（tasks）——而非淡化、重新解读或默认忽略相关原则。若章程原则本身需要变更，必须在 `/speckit.analyze` 之外通过单独、明确的章程更新流程完成。

## 执行步骤

### 1. 初始化分析上下文

从代码库根目录运行一次 `.specify/scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks` 脚本，并解析返回的JSON数据以获取 FEATURE_DIR（功能目录）和 AVAILABLE_DOCS（可用文档）。推导绝对路径：

- 规格说明文件（SPEC）= FEATURE_DIR/spec.md
- 计划文件（PLAN）= FEATURE_DIR/plan.md
- 任务文件（TASKS）= FEATURE_DIR/tasks.md

若任一必要文件缺失，终止操作并输出错误信息（指导用户运行对应的前置命令以补全缺失文件）。
对于参数中包含单引号的情况（如 "I'm Groot"），需使用转义语法：例如 'I'\''m Groot'（若可行，也可使用双引号："I'm Groot"）。

### 2. 加载工件内容（渐进式披露）

仅从每个工件中加载完成分析所需的最少必要上下文：

**从spec.md中加载**：
- 概述/背景
- 功能需求
- 非功能需求
- 用户故事
- 边缘场景（若存在）

**从plan.md中加载**：
- 架构/技术栈选择
- 数据模型引用
- 实施阶段
- 技术约束

**从tasks.md中加载**：
- 任务ID
- 任务描述
- 阶段分组
- 并行标记 [P]
- 引用的文件路径

**从章程文件中加载**：
- 加载 `.specify/memory/constitution.md` 以验证相关原则的合规性

### 3. 构建语义模型

创建内部表征（请勿在输出中包含工件原始内容）：

- **需求清单**：为每一项功能需求和非功能需求分配稳定的标识键（基于祈使句式生成短标识；例如，"用户可上传文件" → `user-can-upload-file`）
- **用户故事/操作清单**：梳理独立的用户操作及对应的验收标准
- **任务覆盖映射**：将每个任务映射到一个或多个需求/用户故事（通过关键词或显式引用模式如ID、关键短语进行推断）
- **章程规则集**：提取原则名称及带有MUST/SHOULD（必须/应当）的规范性表述

### 4. 检测环节（高token效率分析）

聚焦高价值发现。总计最多输出50条发现结果；其余结果汇总至溢出摘要中。

#### A. 重复项检测
- 识别近乎重复的需求
- 标记需整合的低质量表述

#### B. 模糊性检测
- 标记缺乏可量化标准的模糊形容词（如快速、可扩展、安全、直观、健壮等）
- 标记未解决的占位符（如TODO、TKTK、???、`<placeholder>` 等）

#### C. 描述不充分问题
- 仅包含动词、但缺失对象或可量化结果的需求
- 验收标准未对齐的用户故事
- 引用了spec/plan中未定义的文件或组件的任务

#### D. 章程一致性检测
- 任何违反章程中MUST（必须）类原则的需求或计划内容
- 缺失章程中强制要求的章节或质量关卡

#### E. 覆盖缺口检测
- 无关联任务的需求
- 未映射到任何需求/用户故事的任务
- 任务中未体现的非功能需求（如性能、安全）

#### F. 不一致性检测
- 术语漂移（同一概念在不同文件中命名不同）
- 计划中引用但规格说明中缺失的数据实体（或反之）
- 任务排序矛盾（如集成任务排在基础搭建任务之前且无依赖说明）
- 冲突的需求（如一项要求使用Next.js，另一项指定Vue）

### 5. 严重程度赋值

采用以下启发式规则对发现结果排序：

- **CRITICAL（严重）**：违反章程MUST条款、核心规格工件缺失，或阻碍基线功能实现且无覆盖的需求
- **HIGH（高）**：重复/冲突的需求、模糊的安全/性能属性、不可测试的验收标准
- **MEDIUM（中）**：术语漂移、非功能任务覆盖缺失、描述不充分的边缘场景
- **LOW（低）**：格式/措辞优化、不影响执行顺序的轻微冗余

### 6. 生成精简分析报告

输出Markdown格式的报告（不写入文件），结构如下：

## 规格分析报告

| ID | 类别 | 严重程度 | 位置 | 摘要 | 建议 |
|----|----------|----------|-------------|---------|----------------|
| A1 | 重复项 | 高 | spec.md:第120-134行 | 两处相似的需求... | 合并表述，保留更清晰的版本 |

（每条发现结果对应一行；生成以类别首字母为前缀的稳定ID。）

**覆盖情况汇总表：**

| 需求标识键 | 是否有对应任务 | 任务ID | 备注 |
|-----------------|-----------|----------|-------|

**章程一致性问题：**（如有）

**未映射任务：**（如有）

**指标：**

- 总需求数
- 总任务数
- 覆盖率（有至少1个关联任务的需求占比）
- 模糊性问题数量
- 重复项数量
- 严重问题数量

### 7. 提供后续行动建议

在报告末尾输出简洁的“后续行动”模块：

- 若存在CRITICAL级问题：建议在执行 `/speckit.implement` 前解决
- 若仅存在LOW/MEDIUM级问题：用户可继续推进，但需提供优化建议
- 给出明确的命令建议：例如，“运行 /speckit.feature 生成/细化 Feature spec.md”、“运行 /speckit.plan 调整架构”、“手动编辑tasks.md，补充对'performance-metrics'（性能指标）的任务覆盖”

### 8. 提供整改建议

向用户询问：“是否需要我为排名前N的问题提供具体的整改编辑建议？”（**请勿自动执行**整改操作。）

## 操作原则

### 上下文效率

- **高价值低token输出**：聚焦可落地的发现结果，而非详尽的文档罗列
- **渐进式披露**：增量加载工件内容；避免将所有内容纳入分析
- **token高效输出**：发现结果表格最多显示50行；其余内容汇总展示
- **结果确定性**：无变更情况下重复运行，应生成一致的ID和统计数据

### 分析准则

- **禁止修改文件**（本次分析为只读操作）
- **禁止虚构缺失章节**（若内容缺失，需准确报告）
- **优先处理章程违规问题**（此类问题一律判定为CRITICAL级）
- **以示例替代穷尽式规则**（引用具体案例，而非泛化的模式）
- **无问题时友好反馈**（输出包含覆盖统计的成功报告）

## 上下文

$ARGUMENTS
```